
---
title: "osm_streets_download_and_check"
author: "Benjamin Labohm"
date: "`r Sys.Date()`"
output: html_document
---

## Packages
Loading required packages

```{r dirs and packages, echo=FALSE}
# Directories
projectDir <- "D:/LandOeko/AgeingWell/"
dataDir <- paste0(projectDir, "data/")
libDir <- paste0(projectDir, "lib/")

# Package loading
req_pkg = c("dplyr", "tibble", "tidyr", "sf", "osmdata")
req_pkg_install <- setdiff(req_pkg, rownames(installed.packages(lib = libDir)))
lapply(req_pkg_install, install.packages, character.only = TRUE, lib = libDir)
lapply(req_pkg, require, character.only = TRUE, lib = libDir)

# load functions
getwd() %>%
    paste0("/osm_download_funs.R") %>%
    source()
getwd() %>%
    paste0("/network_cleaning_funs.R") %>%
    source()
```

## Data
Load input data
- target LOR
- target OSM keys

```{r data input}
# load LOR polygons
lor_path <- paste0(dataDir, "lor_target_plr.gpkg")
lor_polygons <- read_sf(lor_path)
plot(lor_polygons$geom)  


```

## Download OSM
Download OSM data in target LOR
- by LOR
- by key
- save raw data as osm_raw.gpkg

```{r download OSM}
# by LOR
# i <- 1

# Path for saving raw OSM data
# distance parameter
d <- 1000
osm_raw_dir <- paste0(dataDir, "osm_streets_raw/")
clean_dir_create(osm_raw_dir)

for (i in 1:nrow(lor_polygons)) {

  target_lor <- lor_polygons[i,]
  
  osm_raw_path <- paste0(osm_raw_dir, target_lor$PLR_NAME, ".gpkg")
  osm_data_tmp <- OSM_downloader(loc = target_lor, key = "highway", d = d)
  osm_data_tmp$osm_lines %>%
    select(matches("^highway$|^surface$|^smoothness$|^sidewalk$")) %>%
    #na.omit() %>%
    #rename(value = 1) %>%
    #mutate("key" = key) %>%
    write_sf(osm_raw_path, append = FALSE)
    
}

```

## Filter OSM
- filter for values
- save filtered data as osm_clean.gpkg

```{r inspect OSM}
# # list files in osm raw directory
# osm_raw_paths <- list.files(osm_raw_dir, full.names = TRUE)
# osm_clean_dir <- paste0(dataDir, "osm_streets_spat_filter/")
# clean_dir_create(osm_clean_dir)
# 
# # filter files spatially and by values
# # lor_name <- lor_polygons$BZR_NAME[1]
# for (lor_name in lor_polygons$PLR_NAME) {
#   
#   lor_polygon <- filter(lor_polygons, PLR_NAME == lor_name)
#   grep(lor_name, osm_raw_paths, value = TRUE) %>%
#     read_sf() %>% 
#     st_transform(st_crs(lor_polygon)) %>% 
#     st_filter(lor_polygon) %>% 
#     #filter(value %in% target_values) %>% 
#     write_sf(paste0(osm_clean_dir, lor_name, ".gpkg"), overwrite = TRUE)
# }

```

## Test
Inspect OSM data for completeness 
- how many 'highways' have smoothness / surface params?
- [https://dashboard.ohsome.org]

```{r spat filter OSM}
# retrieve all OSM keys in study area
osm_raw_paths <- list.files(osm_raw_dir, full.names = TRUE)

osm_streets_sf <- osm_raw_paths[1] %>% 
  read_sf() 
for (osm_sf_path in osm_raw_paths[2:length(osm_raw_paths)]) {
  osm_streets_sf <- osm_sf_path %>% 
    read_sf() %>% 
    bind_rows(osm_streets_sf)
}

# classify OSM data into groups with osm key df
osm_streets_sf %>%
  st_transform(25833) %>% 
  write_sf(paste0(dataDir, "osm_streets_raw.gpkg"), append = FALSE)
```


```{r percentage OSM}
osm_streets_sf$street_length <- st_length(osm_streets_sf$geom)
n <- sum(osm_streets_sf$street_length)
n_smoothness <- osm_streets_sf %>%
  select(smoothness, street_length) %>%
  na.omit()
n_surface <- osm_streets_sf %>%
  select(surface, street_length) %>%
  na.omit()

sum(n_smoothness$street_length) / n * 100
sum(n_surface$street_length) / n * 100

```



```{r clean Network}
to_crs <- 25833
osm_streets_raw_dir <- paste0(dataDir, "osm_streets_raw.gpkg")

osm_street_data <- read_sf(osm_streets_raw_dir) %>% 
  st_point_on_surface() %>% 
  st_buffer(.1)

lor_wkt <- st_as_text(st_buffer(lor_polygons$geom[1], d))
osm_target_streets <- read_sf(osm_streets_raw_dir, 
                              wkt_filter = lor_wkt)
osm_network_clean <- networkCleaner(osm_target_streets, crs = to_crs)
  
for (target_lor in lor_polygons$geom[2:nrow(lor_polygons)]) {

    lor_wkt <- st_as_text(st_buffer(target_lor, d))
  osm_target_streets <- read_sf(osm_streets_raw_dir, 
                                wkt_filter = lor_wkt)
  osm_target_streets_clean <- networkCleaner(osm_target_streets, crs = to_crs)
  osm_network_clean <- bind_rows(osm_network_clean, osm_target_streets_clean)

}
#osm_network_clean

st_join(osm_network_clean, osm_street_data) %>% 
  filter(., st_is_valid(st_geometry(.)),
         !st_is_empty(st_geometry(.))) %>% 
  write_sf(paste0(dataDir, "_osm_network_clean.gpkg"), append = FALSE)
```